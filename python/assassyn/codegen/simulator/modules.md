# Module Generation

This module generates the simulation of each Assassyn [module](../../ir/module/),
including [pipeline stage](../../ir/module/module.py) and [downstream](../../ir/module/downstream.py)
in the folder `modules/` of the generated code.

## Exposed Interface

```python
def dump_modules(sys: SysBuilder, fd):
```

This function iterates over all the modules within the `sys`tem
to the given `fd`.
This function instantiates `ElaborateModule`, which provides the key methods of dumping each module.

## Generated Module

### DRAM Module

DRAM module is special because `Ramulator2` adopts a callback-based response interface.
The callback function should have the signature like below:

```rust
extern "C" fn callback_of_<dram>(req: *mut Request, sim: *mut c_void);
```

- This callback function will be associated with the each `Request`'s
  callback field sent to this memory module to hook the responses.
  Refer to [ramulator.rs](../../../../tools/rust-sim-runtime/src/ramulator2.rs)
  for more details on `Request`.

This callback function should act respectively to read and write responses:
- If `req.type_id == 0`, it is a read. Slice the data from `address * 8`,
  in total `width` bits from the `sim._payload_<some-array>` array that is associated
  with this DRAM.
- If `req.type_id == 1`, it is a write. Write the data
  to the slice the data from `address * 8` and in total `width` bits.
  To find the data to be written, it matches the address from
  the `MemoryInterface` `write_buffer`. After writing it, the data
  is removed from the `write_buffer`.

This callback function should be dumped in the same file as the DRAM module,
to minimize the visibility of this function.

### Pipeline Stage & Downstream

Each generated module looks like below, which returns if this module is properly executed.
If the module successfully hits the end of the module, it returns `true`.
When it comes to a `wait_until` intrinsic, and the condition is not true,
it returns `false`.

This function will be exposed in `super::modules::*` and
invoked by `simulate_<module-name>` generated by [simulator.py](./simulator.py).

```rust
pub fn <module-name>(sim: &mut Simulator) -> bool {
```

Then it traverses all the components of within the module to dump the code accordingly
using the [visitor pattern](../../ir/visitor.py).


### Block

Block generation is done by `visit_block` of the visitor pattern.
- Conditional block is an if-statement.
- Cycled block is an `if sim.stamp / 100 == cycle`, as [simulator](./simulator.md)
  adopts a fixed point number for time stamp.

### Expression

Expression generation is done by `visit_expr` in visitor pattern.
The expression dumping are first dispatched to implementations in [_expr](./_expr/),
and then after dumping the expression itself, it also generates
the expression exposure --- if this expression is used by
an external module, write it to the `sim` context by generating

```rust
sim.<expr>_value = Some(value);
```

### IntImm

It provides helper function to generate the leaf node, immediate constants
in `visit_intimm`.